[English](./README.md) | Русский

# get-config
Получает конфигурации сетевых устройств через telnet-сессию.

Данный скрипт предназначен для опроса различных управляемых сетевых устройств (коммутаторы, маршрутизаторы, МСЭ и т.п.) с целью автоматического сбора их конфигурации.
Подключение к устройствам осуществляется с использованием telnet-соединения, которое реализовано через класс [Net::Telnet](https://github.com/ruby/net-telnet).

## Установка
Для работы потребуется установить [Ruby](https://www.ruby-lang.org/ru/documentation/installation/).
Также, необходимо установить класс [Net::Telnet](https://github.com/ruby/net-telnet) через библиотеку gem:
```
$ gem install net-telnet
```

## Использование
Скрипт состоит из двух файлов: исполняемый **[get-conf.rb](./get-conf.rb)** и поключаемый **[templates.rb](./templates.rb)**.
Файл **[templates.rb](./templates.rb)** содержит шаблоны опроса устройств.

### Конфигурация
При первом запуске создаются три файла в формате [YAML](https://ru.wikipedia.org/wiki/YAML): **config.yml**, **pool.yml** и **pswd.yml**.
В файле **config.yml** содержится блок основной конфигурации. Для работы по умолчанию никакие изменения не требуются.
```yaml
---
:archv_dir: archive    # Путь к каталогу в котором будет храниться архив конфигураций
:pool_file:
- pool.yml             # Название файла в котором содержится пул устройств
- pool2.yml            # При необходимости можно использовать несколько пулов
:pswd_file: pswd.yml   # Название файла в котором содержится учетная информация для доступа к устройствам
:error_log: errors.log # Путь к лог-файлу
```

В файле **pool.yml** необходимо указать все устройства которые будут опрашиваться:
``` yaml
---
- :name: device1     # Название устройства, с таким именем будет создан файл в каталоге архива (ОБЯЗАТЕЛЬНО) 
  :host: 192.168.1.1 # IP-адрес или сетевое имя устройства на которое устанавливается telnet-соединение (ОБЯЗАТЕЛЬНО)
  :type: cisco_user  # Тип устройства, соответствует названию шаблона (метода) из templates.rb  по которому будет проходить опрос конфигурации (ОБЯЗАТЕЛЬНО)
  :port: 23          # Порт для telnet доступа к устройству (по умолчанию 23)
  :user: username    # Логин (по умолчанию используется стандартный из pswd.yml)
  :pswd: password    # Пароль (по умолчанию используется стандартный из pswd.yml)
  :esif: gi2/0       # Интерфейс платы EtherSwitch (при необходимости, по умолчанию gi2/0)
  :logs: device.log  # Лог-файл опроса устройства (по умолчанию не используется)
  :pgrp: devices     # Название парольной группы из файла pswd.yml
- :name: device2     # Следующее устройство
  :host: 192.168.1.2
  :type: juniper
```
Обязательные параметры: ```:name: :host: :type:```

Файл **pswd.yml** содержит учетную информацию (логины/пароли) для доступа к устройствам:
``` yaml
---
- :user: username # Имя пользователя по умолчанию, если не задан в pool.yml (ОБЯЗАТЕЛЬНО) 
  :pswd: password # Пароль по умолчанию, если не задан в pool.yml (ОБЯЗАТЕЛЬНО)
  :type: default  # Не изменять, определяет авторизацию по умолчанию (ОБЯЗАТЕЛЬНО)
- :user: username
  :pswd: password
  :type: juniper  # Авторизация для доступа к отдельному типу устройств или группе :pgrp: из pool.yml
- :user: username
  :pswd: password
  :type:          # Авторизация для доступа к нескольким типам устройств
  - cisco_user
  - cisco_enable
```

Максимальный приоритет имеет имя пользователя и пароль заданные в **pool.yml**. Eсли они не заданы в **pool.yml**, а в файле **pswd.yml** есть авторизация для определенного типа устройств, то для данных устройств устанавливется логин/пароль из **pswd.yml**.

Если тип устройства не найден в **pswd.yml**, устанавливается авторизация по умолчанию (```:type: default```).

Также, есть возможность определять парольную группу ```:pgrp:``` в **pool.yml**, которой будет соответствовать ```:type:``` в **pswd.yml**. Следует отметить, что если установлена авторизация для типа устройств, то парольную группу в **pswd.yml** следует располагать выше авторизации по типу, чтобы она имела приоритет.

Возможно отдельное использование ```:user:``` и ```:pswd:``` в **pool.yml**. В случае если один из параметров не задан, то он будет взят **pswd.yml**, при этом установленный в **pool.yml** останется.

### Запуск
При запуске скрипта в каталоге архива (по умолчанию **./archive**) создается каталог с названием в виде текущей даты. Если такой каталог уже создан, то создается новый с указанием метки времени. В случае если установлено несколько пулов устройств, в каталоге даты создаются подкаталоги с именами пулов.

Опрос устройств идет по порядку заданному в **pool.yml**. В архивном каталоге сохраняются файлы конфигурации. Ошибки при опросе устройств сохраняются в лог-файле (по умолчанию **./errors.log**).

В [templates.rb](./templates.rb) определены шаблоны типов устройств для их опроса по telnet. Шаблоны оформлены в виде отдельных методов с использованием комманд класса [Net::Telnet](https://github.com/ruby/net-telnet). В случае необходимости возможно добавление новых шаблонов (методов). В текущей версии заданы следующие типы сетевых устройств:

- omnistack_enable - Alcatel OmniStack LS с использованием enable (пароль установлен)
- omnistack_user - Alcatel OmniStack LS авторизация по имени пользователя
- omniswitch - Alcatel OmniSwitch
- cisco_user - Cisco авторизация по имени пользователя
- cisco_enable - Cisco с использованием enable (пароль установлен)
- cisco_noenable - Cisco без использования enable (privilege level 15)
- cisco_es - модуль Cisco EtherSwitch доступный через service-module session
- cisco_asa - Cisco ASA
- hp_super - HP с использованием super (пароль установлен)
- hp_nosuper - HP без использования super (user privilege 3)
- hp_user - HP авторизация по имени пользователя
- h3c_nosuper - H3C/3Com без использования super
- h3c_user - H3C/3Com вторизация по имени пользователя
- juniper - Juniper
- dlink_new - D-Link новый CLI похожий на Cisco (15xx)
- dlink_old - D-Link старый собственный CLI (12xx/32xx/35xx)
- eltex - Eltex
- extreme - Extreme
- riverstone - Riverstone
