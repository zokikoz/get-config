[English](./README.md) | Русский

# get-config
Получает конфигурации сетевых устройств через telnet-сессию

Данный скрипт предназначен для опроса различных управляемых сетевых устройств (коммутаторы, маршрутизаторы, МСЭ и т.п.) с целью автоматического сбора их конфигурации.
Подключение к устройствам осуществляется с использованием telnet-соединения, которое реализовано через класс [Net::Telnet](https://github.com/ruby/net-telnet).

## Установка
Для работы потребуется установить [Ruby](https://www.ruby-lang.org/ru/documentation/installation/).
Также, необходимо установить класс Net::Telnet через библиотеку gem:
```
$ gem install net-telnet
```

## Использование
Скрипт состоит из двух файлов: исполняемый **[get-conf.rb](./get-conf.rb)** и поключаемый **[templates.rb](./templates.rb)**.
Файл **[templates.rb](./templates.rb)** содержит шаблоны опроса устройств.
В начале файла **[get-conf.rb](./get-conf.rb)** есть блок основной конфигурации. Для работы по умолчанию никакие изменения не требуются.
```ruby
CONFIG = {
  archv_dir: 'archive',    # Путь к каталогу в котором хранится архив конфигураций
  pool_file: %w[pool.yml], # Название файла в котором содержится пул устройств, при использовании нескольких файлов указать их через пробел
  pswd_file: 'pswd.yml',   # Название файла в котором содержится учетная информация для доступа к устройствам
  error_log: 'errors.log'  # Путь к лог-файлу
}.freeze
```
При первом запуске создаются два файла в формате [YAML](https://ru.wikipedia.org/wiki/YAML): **pool.yml** и **pswd.yml**.

В файле **pool.yml** необходимо указать все устройства которые будут опрашиваться в следующем виде:
``` yaml
---
- :name: device1     # Название устройства, с таким именем будет создан файл в каталоге архива (ОБЯЗАТЕЛЬНО) 
  :host: 192.168.1.1 # IP-адрес или сетевое имя устройства на которое устанавливается telnet-соединение (ОБЯЗАТЕЛЬНО)
  :type: cisco_user  # Тип устройства, соответствует названию шаблона (метода) из templates.rb  по которому будет проходить опрос конфигурации (ОБЯЗАТЕЛЬНО)
  :port: 23          # Порт для telnet доступа к устройству (по умолчанию 23)
  :user: username    # Логин (по умолчанию используется стандартный из pswd.yml)
  :pswd: password    # Пароль (по умолчанию используется стандартный из pswd.yml)
  :esif: gi2/0       # Интерфейс платы EtherSwitch (при необходимости, по умолчанию gi2/0)
  :logs: device.log  # Лог-файл опроса устройства (по умолчанию не используется)
  :pgrp: devices     # Название парольной группы из файла pswd.yml
- :name: device2     # Следующее устройство
  :host: 192.168.1.2
  :type: juniper
```
Обязательные параметры: **:name: :host: :type:**

Файл **pswd.yml** содержит учетную информацию (логины/пароли) для доступа к устройствам:
``` yaml
---
- :user: username # Имя пользователя по умолчанию, если не задан в pool.yml (ОБЯЗАТЕЛЬНО) 
  :pswd: password # Пароль по умолчанию, если не задан в pool.yml (ОБЯЗАТЕЛЬНО)
  :type: default  # Не изменять, определяет авторизацию по умолчанию (ОБЯЗАТЕЛЬНО)
- :user: username
  :pswd: password
  :type: juniper  # Авторизация для доступа к отдельному типу устройств или группе :pgrp: из pool.yml
- :user: username
  :pswd: password
  :type:          # Авторизация для доступа к нескольким типам устройств
  - cisco_user
  - cisco_enable
```

Максимальный приоритет имеет имя пользователя и пароль заданные в **pool.yml**. Eсли они не заданы в **pool.yml**, а в файле **pswd.yml** есть авторизация для определенного типа устройств, то для данных устройств устанавливется логин/пароль из **pswd.yml**. Если тип устройства не найден в **pswd.yml**, устанавливается авторизация по умолчанию (:type: default).
Также, есть возможность определять парольную группу :pgrp: в **pool.yml**, которой будет соответствовать :type: в **pswd.yml**. Следует отметить, что если установлена авторизация для типа устройств, то парольную группу в **pswd.yml** следует располагать выше авторизации по типу, чтобы она имела приоритет.
Возможно отдельное использование :user: и :pswd: в **pool.yml**. В случае если один из параметров не задан, то он будет взят **pswd.yml**, при этом установленный в **pool.yml** останется.

При запуске скрипта в каталоге архива (по умолчанию **./archive**) создается каталог с названием в виде текущей даты. Если такой каталог уже создан, то создается новый с указанием метки времени. В случае если установлено несколько пулов устройств в каталоге даты создаются подкаталоги с именами пулов.

Опрос устройств идет по порядку заданному в **pool.yml**. В архивном каталоге сохраняются файлы конфигурации. Ошибка при опросе устройства сохраняется в лог-файле (по умолчанию **./errors.log**).

В [templates.rb](./templates.rb) определены шаблоны типов устройств для их опроса по telnet. Шаблоны оформлены в виде отдельных методов с использованием комманд класса [Net::Telnet](https://github.com/ruby/net-telnet). В случае необходимости возможно добавление новых шаблонов (методов). В текущей версии заданы следующие типы сетевых устройств:

- omnistack_enable - Alcatel OmniStack LS enable password login
- omnistack_user - Alcatel OmniStack LS username/password login
- omniswitch - Alcatel OmniSwitch
- cisco_user - Cisco username/password login
- cisco_enable - Cisco enable password login
- cisco_noenable - Cisco no enable password required (privilege level 15)
- cisco_es - Cisco EtherSwitch module
- cisco_asa - Cisco ASA
- hp_super - HP super password login
- hp_nosuper - HP no super password required (user privilege 3)
- hp_user - HP username/password login
- h3c_nosuper - H3C/3Com no super password
- h3c_user - H3C/3Com username/password login
- juniper - Juniper
- dlink_new - D-Link new cisco-like style CLI (15xx)
- dlink_old - D-Link old own style CLI (12xx/32xx/35xx)
- eltex - Eltex
- extreme - Extreme
- riverstone - Riverstone
